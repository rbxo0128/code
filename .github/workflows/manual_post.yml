name: Manual Blog Post

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'ë¬¸ì œ í”Œëž«í¼'
        type: choice
        options:
          - BOJ
          - Programmers
        required: true

      difficulty:
        description: 'ë‚œì´ë„ ì„ íƒ (BOJ: Bronze/Silver/Gold/... Programmers: 0~5)'
        type: string
        required: true

      problem_id:
        description: 'ë¬¸ì œ ë²ˆí˜¸ (ì‰¼í‘œë¡œ ì—¬ëŸ¬ ê°œ ìž…ë ¥ ê°€ëŠ¥, ì˜ˆ: 1027,1002,1003)'
        type: string
        required: true

      post_immediately:
        description: 'ì¦‰ì‹œ í¬ìŠ¤íŒ… ì—¬ë¶€'
        type: boolean
        default: true

jobs:
  post-to-blog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build problem path dynamically
        id: build_path
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          DIFFICULTY="${{ github.event.inputs.difficulty }}"
          ID="${{ github.event.inputs.problem_id }}"

          if [[ "$PLATFORM" == "BOJ" ]]; then
            BASE_DIR="ë°±ì¤€"
          else
            BASE_DIR="í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤"
          fi

          # ë¬¸ì œ í´ë” ìžë™ íƒìƒ‰ (ë¬¸ì œ ì œëª© ë°˜ì˜ëœ í´ë” ì°¾ê¸°)
          FOUND_PATH=$(find "$BASE_DIR/$DIFFICULTY" -maxdepth 1 -type d -name "${ID}.*" | head -n 1)

          if [[ -z "$FOUND_PATH" ]]; then
            echo "âŒ ë¬¸ì œ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $BASE_DIR/$DIFFICULTY/$ID.*"
            exit 1
          fi

          echo "ðŸ“ ê²½ë¡œ íƒìƒ‰ ì„±ê³µ: $FOUND_PATH"
          echo "problem_path=$FOUND_PATH" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Post to Blog (multiple)
        if: github.event.inputs.post_immediately == 'true'
        env:
          BLOG_API_URL: ${{ secrets.BLOG_API_URL }}
          BLOG_API_KEY: ${{ secrets.BLOG_API_KEY }}
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          DIFFICULTY="${{ github.event.inputs.difficulty }}"
          IDS="${{ github.event.inputs.problem_id }}"

          if [[ "$PLATFORM" == "BOJ" ]]; then
            BASE_DIR="ë°±ì¤€"
          else
            BASE_DIR="í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤"
          fi

          # ì‰¼í‘œë¡œ ë¶„ë¦¬
          IFS=',' read -ra PROBLEM_IDS <<< "$IDS"

          for ID in "${PROBLEM_IDS[@]}"; do
            ID=$(echo "$ID" | xargs)  # ê³µë°± ì œê±°
            echo "ðŸ”Ž íƒìƒ‰: $BASE_DIR/$DIFFICULTY/$ID.*"
            FOUND_PATH=$(find "$BASE_DIR/$DIFFICULTY" -maxdepth 1 -type d -name "${ID}.*" | head -n 1)

            if [[ -z "$FOUND_PATH" ]]; then
              echo "âŒ ë¬¸ì œ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $BASE_DIR/$DIFFICULTY/$ID.*"
              continue
            fi

            echo "ðŸ“ í¬ìŠ¤íŒ… ì‹œìž‘: $FOUND_PATH"
            PROBLEM_PATH="$FOUND_PATH" python .github/scripts/post_single_problem.py

            echo "â± 5ì´ˆ ëŒ€ê¸°..."
            sleep 5
          done

      - name: Show Preview Only
        if: github.event.inputs.post_immediately != 'true'
        run: |
          echo "ðŸ“‹ ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ â€” ì‹¤ì œ í¬ìŠ¤íŒ…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
