name: Auto Blog Post (BaekjoonHub)

on:
  push:
    branches:
      - main
    paths:
      - "ë°±ì¤€/**"
      - "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/**"

jobs:
  auto-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # ì´ì „ ì»¤ë°‹ê³¼ diff ë¹„êµìš©

      - name: Detect newly added problem directories
        run: |
          echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ íƒìƒ‰ ì¤‘..."

          git config --global core.quotepath false

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "ğŸ” Diff range: $BEFORE â†’ $AFTER"

          git diff --name-only --diff-filter=A "$BEFORE" "$AFTER" \
          | grep 'README.md$' \
          | while read -r file; do
              dirname "$file"
            done \
          | sort -u > problem_dirs.txt

          echo "ğŸ“ ìƒˆë¡œ ì¶”ê°€ëœ ë¬¸ì œ í´ë”:"
          cat problem_dirs.txt || true



      - name: Auto post new problems
        env:
          BLOG_API_URL: ${{ secrets.BLOG_API_URL }}
          BLOG_API_KEY: ${{ secrets.BLOG_API_KEY }}
          BLOG_PROXY: ${{ secrets.BLOG_PROXY}}
        run: |
          if [ ! -s problem_dirs.txt ]; then
            echo "ğŸ“­ ìƒˆë¡œ ì¶”ê°€ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi

          while read PROBLEM_PATH; do
            echo "ğŸš€ ìë™ í¬ìŠ¤íŒ… ì‹œì‘: $PROBLEM_PATH"
            PROBLEM_PATH="$PROBLEM_PATH" python .github/scripts/post_single_problem.py

            echo "â± 5ì´ˆ ëŒ€ê¸°..."
            sleep 5
          done < problem_dirs.txt


